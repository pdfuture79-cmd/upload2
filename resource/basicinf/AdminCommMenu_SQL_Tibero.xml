<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="CommMenu">
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<resultMap id="CommMenuList" class="egovframework.admin.basicinf.service.CommMenu">
		<result property="menuId"    column="MENU_ID"     />
		<result property="menuIdPar"    column="MENU_ID_PAR"     />
		<result property="level"   	 column="LEVEL"    />
		<result property="menuTitle"   	 column="MEMU_TITLE"    />
		<result property="reCnt"    column="RE_CNT"     />
		<result property="menuNm"    column="MENU_NM"     />
		<result property="menuUrl"   column="MENU_URL"    />
		<result property="menuAcc"   column="MENU_ACC"    />
		<result property="menuNav"   column="MENU_NAV"    />
		<result property="menuParam"   column="MENU_PARAM"    />
	</resultMap>
	
	<resultMap id="CommMenuGridList" class="egovframework.admin.basicinf.service.CommMenu">
		<result property="menuId"    	column="MENU_ID"     />
		<result property="menuNm"    	column="MENU_NM"     />
		<result property="menuUrl"   	column="MENU_URL"    />
		<result property="menuParam"   	column="MENU_PARAM"    />
		<result property="Level"	  	column="LEVEL"       />
		<result property="menuLv"	  	column="MENU_LV"       />
		<result property="useYn"	  	column="USE_YN"       />
		<result property="vOrder"	  	column="V_ORDER"       />
		<result property="menuSysDcd"	column="MENU_SYS_DCD"      />
	</resultMap>
	
	<resultMap id="CommMenuGridListKeywd" class="egovframework.admin.basicinf.service.CommMenu">
		<result property="menuId"    	column="MENU_ID"     />
		<result property="menuNm"    	column="MENU_NM"     />
		<result property="menuUrl"   	column="MENU_URL"    />
		<result property="menuParam"   	column="MENU_PARAM"    />
		<result property="menuLv"	  	column="MENU_LV"       />
		<result property="useYn"	  	column="USE_YN"       />
		<result property="vOrder"	  	column="V_ORDER"       />
		<result property="menuSysDcd"	column="MENU_SYS_DCD"      />
	</resultMap>
	
	<resultMap id="CommMenuListInfo" class="egovframework.admin.basicinf.service.CommMenu">
		<result property="menuId"    	    column="MENU_ID"			jdbcType="DECIMAL"     />
		<result property="menuIdPar"   		column="MENU_ID_PAR"		jdbcType="DECIMAL"     />
		<result property="menuIdParDesc"	column="MENU_ID_PAR_DESC"   jdbcType="VARCHAR" />
		<result property="menuNm"    		column="MENU_NM"    		jdbcType="VARCHAR" />
		<result property="menuUrl"   		column="MENU_URL"   		jdbcType="VARCHAR" />
		<result property="menuParam"   		column="MENU_PARAM" 		jdbcType="VARCHAR"   />
		<result property="menuDesc"	  		column="MENU_DESC"  		jdbcType="VARCHAR"     />
		<result property="useYn"	  		column="USE_YN"     		jdbcType="VARCHAR"  /> 
		<result property="vOrder"	  		column="V_ORDER"     		jdbcType="DECIMAL"  />
		<result property="menuSysDcd"	  	column="MENU_SYS_DCD"      />
	</resultMap>
	
	<select id="CommMenuDAO.selectCommMenuList" parameterClass="egovframework.admin.basicinf.service.CommUsr" resultMap="CommMenuList" >
	   
		   SELECT M.MENU_ID
		        , M.MENU_ID_PAR
		        , LEVEL
			    , (CASE WHEN LEVEL> 1 THEN '└' ELSE '' END) || LPAD(' ',  LEVEL, '→')  ||  M.MENU_NM AS MEMU_TITLE
			    , C.RE_CNT
			    , M.MENU_NM
			    , M.MENU_URL
			    , C.MENU_ACC			    	
			    , SUBSTR(SYS_CONNECT_BY_PATH(M.MENU_NM, ' > '),4) AS MENU_NAV			    
			    , M.MENU_PARAM 			   
			FROM TB_COMM_MENU  M 
		         INNER JOIN 
				 (
					SELECT * FROM 
					(
							SELECT M.MENU_ID, C.ACC_CD, NVL(C.MENU_ACC,0) AS MENU_ACC
							     ,(SELECT COUNT(*) -1  
							         FROM TB_COMM_MENU
							        WHERE USE_YN = 'Y'
							        START WITH MENU_ID = M.MENU_ID
							        CONNECT BY PRIOR MENU_ID = MENU_ID_PAR
							       ) AS RE_CNT
							     , M.MENU_PARAM
							     ,(SELECT COUNT(*) 
                                     FROM TB_COMM_MENU X                      
                                          INNER JOIN TB_COMM_MENUACC Y
                                             ON Y.MENU_ID = X.MENU_ID     
                                            AND Y.MENU_ACC !='0'
                                            <isNotEmpty property="accCd" >
	                                            AND Y.ACC_CD = #accCd#
	                                        </isNotEmpty>                                                                                                                                       
                                    WHERE X.MENU_ID_PAR = M.MENU_ID                                                     
                                      AND X.USE_YN = 'Y'   
                                      <isNotEmpty property="menuSysDcd">
						                 AND NVL(X.MENU_SYS_DCD,'ALL') IN (#menuSysDcd#, 'ALL')  
						             </isNotEmpty>      
                                     
                                  ) AS LWL_CNT   
                                 ,(SELECT COUNT(*) 
                                     FROM TB_COMM_MENU X                      
                                          INNER JOIN TB_COMM_MENUACC Y
                                             ON Y.MENU_ID = X.MENU_ID     
                                            AND Y.MENU_ACC !='0'
                                            <isNotEmpty property="accCd" >
                                                AND Y.ACC_CD = #accCd#
                                            </isNotEmpty>                                                                                                                                       
                                    WHERE X.MENU_ID = M.MENU_ID_PAR                                                      
                                      AND X.USE_YN = 'Y'   
                                      <isNotEmpty property="menuSysDcd">
                                         AND NVL(X.MENU_SYS_DCD,'ALL') IN (#menuSysDcd#, 'ALL')  
                                     </isNotEmpty>      
                                     
                                  ) AS UPP_CNT     
							  FROM TB_COMM_MENU  M 
							       INNER JOIN 
                                   (
                                     SELECT ACC_CD
                                          , MENU_ID
                                          , MENU_ACC
                                       FROM TB_COMM_MENUACC
                                      WHERE 1 = 1
                                        AND MENU_ACC !='0'
                                       <isNotEmpty property="accCd" >
                                            AND ACC_CD = #accCd#
                                       </isNotEmpty> 									
                                   )C
							       ON M.MENU_ID = C.MENU_ID
							WHERE  1 = 1 
							  AND M.USE_YN = 'Y' 
					) WHERE MENU_ACC + RE_CNT > 0
				) C ON M.MENU_ID = C.MENU_ID
			WHERE 1 = 1   
			 <isNotEmpty property="menuUrl" >
			     AND M.MENU_URL||M.MENU_PARAM = #menuUrl#
			 </isNotEmpty>
			 <isNotEmpty property="menuSysDcd">
			 	 AND NVL(M.MENU_SYS_DCD,'ALL') IN (#menuSysDcd#, 'ALL')  
			 </isNotEmpty>			 
			  AND M.USE_YN = 'Y' 
			  AND ( (LEVEL = 1  AND C.LWL_CNT > 0) OR 
			        (LEVEL > 1  AND C.UPP_CNT > 0)
			       )
			START WITH ( M.MENU_ID_PAR = 0)
			CONNECT BY PRIOR M.MENU_ID = M.MENU_ID_PAR  
			ORDER SIBLINGS BY M.V_ORDER
	   
	</select> 
	
	<!-- 전체 리스트 조회 -->
	<select id="CommMenuDAO.selectMenuList" parameterClass="egovframework.admin.basicinf.service.CommMenu" resultMap="CommMenuGridList" >
		 SELECT MENU_ID
			  , MENU_NM
			  , MENU_URL
			  , MENU_PARAM
			  , LEVEL
			  , LEVEL AS MENU_LV
			  , DECODE(USE_YN, 'Y', 1, 'N', 0) AS USE_YN
			  , V_ORDER
			  , MENU_SYS_DCD
		  FROM TB_COMM_MENU
		 START WITH MENU_ID_PAR = 0
		 CONNECT BY PRIOR MENU_ID = MENU_ID_PAR
		 ORDER SIBLINGS BY V_ORDER
	</select>
	
	<!-- 전체 리스트 조회 건수 -->
	<select id="CommMenuDAO.selectMenuListCnt" parameterClass="egovframework.admin.basicinf.service.CommMenu" resultClass="java.lang.Integer" >
		SELECT COUNT(*)
		  FROM 
				TB_COMM_MENU
		 		START WITH MENU_ID_PAR = 0
				CONNECT BY PRIOR MENU_ID = MENU_ID_PAR
				ORDER SIBLINGS BY V_ORDER
	</select>
	
	<!-- 키워드 조회 -->
	<select id="CommMenuDAO.selectMenuListKeywd" parameterClass="egovframework.admin.basicinf.service.CommMenu" resultMap="CommMenuGridListKeywd" >
		SELECT
				MENU_ID
			  , MENU_NM
			  , MENU_URL
			  , MENU_PARAM
			  , 0 AS MENU_LV
			  , DECODE(USE_YN, 'Y', 1, 'N', 0) AS USE_YN
			  , V_ORDER
			  , MENU_SYS_DCD
		  FROM 
				TB_COMM_MENU A
		 WHERE  1=1 
		   		<isNotEmpty property="searchWord" >
					<isEqual property="searchWd" compareValue="1">
					AND A.MENU_NM LIKE '%'||#searchWord#||'%'
					</isEqual>
					<isEqual property="searchWd" compareValue="2">
					AND A.MENU_URL LIKE '%'||#searchWord#||'%'
					</isEqual>
				</isNotEmpty>
				<isEqual property="useYn" compareValue="Y" >
					AND A.USE_YN = 'Y'
				</isEqual>	
				<isEqual property="useYn" compareValue="N" >
					AND A.USE_YN = 'N'
				</isEqual>
	 		 
	</select>
	
	<!-- 키워드 조회 건수 -->
	<select id="CommMenuDAO.selectMenuListKeywdCnt" parameterClass="egovframework.admin.basicinf.service.CommMenu" resultClass="java.lang.Integer" >
		SELECT  COUNT(*)
		  FROM 
				TB_COMM_MENU A
		 WHERE  1=1 
		   		<isNotEmpty property="searchWord" >
					<isEqual property="searchWd" compareValue="0" >
					AND A.MENU_ID LIKE '%'||#searchWord#||'%'
					</isEqual>
					<isEqual property="searchWd" compareValue="1">
					AND A.MENU_NM LIKE '%'||#searchWord#||'%'
					</isEqual>
					<isEqual property="searchWd" compareValue="2">
					AND A.MENU_URL LIKE '%'||#searchWord#||'%'
					</isEqual>
				</isNotEmpty>
	</select>
	
	<!-- 상세 조회 -->
	<select id="CommMenuDAO.selectMenuListInfo" parameterClass="egovframework.admin.basicinf.service.CommMenu" resultMap="CommMenuListInfo" >
		 SELECT A.MENU_ID
			  , A.MENU_ID_PAR
			  , CASE WHEN A.MENU_ID_PAR != 0 
			         THEN (SELECT B.MENU_NM FROM TB_COMM_MENU B 
			         		WHERE A.MENU_ID_PAR = B.MENU_ID)
			    ELSE      'X'
			    END MENU_ID_PAR_DESC
			  , A.MENU_NM
			  , A.MENU_URL
			  , A.MENU_PARAM
			  , A.MENU_DESC
			  , A.USE_YN
			  , A.V_ORDER
			  , A.MENU_SYS_DCD
		  FROM TB_COMM_MENU A 
		 WHERE A.MENU_ID=#menuId#
	 		 
	</select>
	
	<!-- 메뉴 ID 조회(최대값+1) -->
	<select id="CommMenuDAO.getMenuId" parameterClass="egovframework.admin.basicinf.service.CommMenu" resultClass="java.lang.Integer">
		SELECT NVL(MAX(MENU_ID), 0)+1
		 FROM TB_COMM_MENU
	</select>
	
	<!-- 상세조회 하위메뉴 리스트 -->
	<select id="CommMenuDAO.selectCommLowMenuList" parameterClass="egovframework.admin.basicinf.service.CommMenu" resultMap="CommMenuGridList" >
		SELECT
				MENU_ID
			  , MENU_NM
			  , MENU_URL
			  , MENU_PARAM	
			  , LEVEL
			  , LEVEL AS MENU_LV
			  , USE_YN
			  , V_ORDER
			  , MENU_SYS_DCD
		  FROM TB_COMM_MENU
 		 START WITH MENU_ID = #menuId#
		 CONNECT BY PRIOR MENU_ID = MENU_ID_PAR
		 ORDER SIBLINGS BY V_ORDER
	 		 
	</select>
	
	<!-- 상세조회 하위메뉴 카운팅 -->
	<select id="CommMenuDAO.selectCommLowMenuListCnt" parameterClass="egovframework.admin.basicinf.service.CommMenu" resultClass="java.lang.Integer" >
		SELECT COUNT(*)
		  FROM TB_COMM_MENU
 		 START WITH MENU_ID = #menuId#
		 CONNECT BY PRIOR MENU_ID = MENU_ID_PAR
		 ORDER SIBLINGS BY V_ORDER  
	</select>
	
	<!-- 상위메뉴 팝업 조회 -->
	<select id="CommMenuDAO.selectCommHighMenuList" parameterClass="egovframework.admin.basicinf.service.CommMenu" resultMap="CommMenuGridList" >
		SELECT MENU_ID
			 , MENU_NM
			 , MENU_URL
			 , MENU_PARAM	
			 , LEVEL
			 , LEVEL AS MENU_LV
			 , MENU_SYS_DCD  
		  FROM TB_COMM_MENU
		 START WITH MENU_ID_PAR = #menuIdPar#
		 CONNECT BY MENU_ID = MENU_ID_PAR
		 ORDER SIBLINGS BY V_ORDER
	 		 
	</select>
	
	<!-- 상위 메뉴 조회 건수 -->
	<select id="CommMenuDAO.selectCommHighMenuListCnt" parameterClass="egovframework.admin.basicinf.service.CommMenu" resultClass="java.lang.Integer" >
			SELECT  COUNT(*)
			  FROM 
					TB_COMM_MENU
			 		START WITH MENU_ID_PAR = #menuIdPar#
					CONNECT BY MENU_ID = MENU_ID_PAR
					ORDER SIBLINGS BY V_ORDER
	</select>
	
	<!-- 메뉴 등록 -->
	<insert id="CommMenuDAO.insertMenu" parameterClass="egovframework.admin.basicinf.service.CommMenu" >
		INSERT INTO TB_COMM_MENU
			(  MENU_ID, MENU_NM
			<isNotEmpty property="menuIdPar" >
			 , MENU_ID_PAR
			</isNotEmpty>
			 , MENU_URL, MENU_PARAM
		     , MENU_DESC		     		    
		     , V_ORDER		     
		     , USE_YN
		     , REG_ID
		     , REG_DTTM
		     , UPD_ID
		     , UPD_DTTM
		     , MENU_SYS_DCD		     
		    )
		VALUES
			( 
			   #menuId#
			 , #menuNm#
			 <isNotEmpty property="menuIdPar" >
			 , #menuIdPar#
			 </isNotEmpty>
			 , #menuUrl#
			 , #menuParam#
			 , #menuDesc#			
			 , NVL(#vOrder#,0) 			 
			 , #useYn#
			 , #sessionUsrId#
			 , SYSDATE
			 , #sessionUsrId#
			 , SYSDATE
			 , #menuSysDcd#			 
			)
	</insert>
	
	<!-- 메뉴 수정 -->	
	<update id="CommMenuDAO.updateMenu" parameterClass="egovframework.admin.basicinf.service.CommMenu" >
		<![CDATA[
		UPDATE TB_COMM_MENU
		  SET MENU_NM      = #menuNm#
		  	, MENU_URL     = #menuUrl#
		  	, MENU_PARAM   = #menuParam#
		  	, MENU_DESC    = #menuDesc#
			, USE_YN       = #useYn#
			, V_ORDER      = #vOrder#
			, UPD_ID       = #sessionUsrId#
			, UPD_DTTM     = SYSDATE
			, MENU_SYS_DCD = #menuSysDcd#	 
		WHERE MENU_ID = #menuId# 	
		]]>
	</update>
	
	<!-- 메뉴 삭제 -->
	<update id="CommMenuDAO.deleteMenu" parameterClass="egovframework.admin.basicinf.service.CommMenu" >
		DELETE FROM TB_COMM_MENU
		 WHERE MENU_ID = #menuId# 	
	</update>
	
	
	<update id="CommMenuDAO.commMenuListUpdateTreeOrder" parameterClass="egovframework.admin.basicinf.service.CommMenu" >
		<![CDATA[
		UPDATE TB_COMM_MENU A 
		   SET A.V_ORDER = #vOrder#
		 WHERE MENU_ID = #menuId#        
		]]>
	</update>
	
</sqlMap>

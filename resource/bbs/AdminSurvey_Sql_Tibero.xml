<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="Survey">
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	 <typeAlias alias="clobHandler" type="com.ibatis.sqlmap.engine.type.ClobTypeHandlerCallback" />
	<resultMap id="SurveyList" class="egovframework.admin.bbs.service.Survey">
		<result property="surveyId" column="SURVEY_ID"/>
		<result property="surveyNm" column="SURVEY_NM"/>
		<result property="langTag" column="LANG_TAG"/>
		<result property="ipDupYn" column="IP_DUP_YN"/>
		<result property="startDttm" column="START_DTTM"/>
		<result property="endDttm" column="END_DTTM"/>
		<result property="orgCd" column="ORG_CD"/>
		<result property="orgNm" column="ORG_NM"/>
		<result property="usrCd" column="USR_CD"/>
		<result property="usrNm" column="USR_NM"/>
		<result property="useYn" column="USE_YN"/>
		<result property="fileYn" column="FILE_YN"/>
	</resultMap>
	
	<resultMap id="SurveyPop" class="egovframework.admin.bbs.service.Survey">
		<result property="surveyId" column="SURVEY_ID"/>
		<result property="surveyNm" column="SURVEY_NM"/>
		<result property="langTag" column="LANG_TAG"/>
		<result property="ipDupYn" column="IP_DUP_YN"/>
		<result property="startDttm" column="START_DTTM"/>
		<result property="endDttm" column="END_DTTM"/>
		<result property="orgCd" column="ORG_CD"/>
		<result property="usrCd" column="USR_CD"/>
		<result property="useYn" column="USE_YN"/>
		<result property="surveyPpose" column="SURVEY_PPOSE"/>
		<result property="surveyExp" column="SURVEY_EXP"/>
		<result property="loginYn" column="LOGIN_YN"/>
		<result property="user1Yn" column="USER1_YN"/>
		<result property="fileYn" column="FILE_YN"/>
		<result property="fileExp" column="FILE_EXP"/>
		<result property="userNameYn" column="user_name_yn"/>
		<result property="userTelYn" column="user_tel_yn"/>
		<result property="userHpYn" column="user_hp_yn"/>
		<result property="userEmailYn" column="user_email_yn"/>
	</resultMap>
	
	<resultMap id="SurveyRetr" class="egovframework.admin.bbs.service.Survey">
		<result property="surveyId" column="SURVEY_ID"/>
		<result property="surveyNm" column="SURVEY_NM"/>
		<result property="langTag" column="LANG_TAG"/>
		<result property="ipDupYn" column="IP_DUP_YN"/>
		<result property="startDttm" column="START_DTTM"/>
		<result property="endDttm" column="END_DTTM"/>
		<result property="orgCd" column="ORG_CD"/>
		<result property="usrCd" column="USR_CD"/>
		<result property="useYn" column="USE_YN"/>
		<result property="surveyPpose" column="SURVEY_PPOSE"/>
		<result property="surveyExp" column="SURVEY_EXP"/>
		<result property="loginYn" column="LOGIN_YN"/>
		<result property="user1Yn" column="USER1_YN"/>
		<result property="orgNm" column="ORG_NM"/>
		<result property="usrNm" column="USR_NM"/>
		<result property="surveyDesc" column="SURVEY_DESC" jdbcType="CLOB" javaType="java.lang.String" typeHandler="clobHandler"/>
		<result property="axisX" column="AXIS_X"/>
		<result property="axisY" column="AXIS_Y"/>
		<result property="fileYn" column="FILE_YN"/>
		<result property="fileExp" column="FILE_EXP"/>
		<result property="userNameYn" column="user_name_yn"/>
		<result property="userTelYn" column="user_tel_yn"/>
		<result property="userHpYn" column="user_hp_yn"/>
		<result property="userEmailYn" column="user_email_yn"/>
	</resultMap>
	
	<select id="SurveyDao.selectSurveyAll" parameterClass="egovframework.admin.bbs.service.Survey" resultMap="SurveyList">
		SELECT   A.SURVEY_ID
			   , A.SURVEY_NM
			   , A.LANG_TAG
			   , A.IP_DUP_YN
			   ,A.START_DTTM
			   , A.END_DTTM
			   , A.ORG_CD
			   , O.ORG_NM
			   , A.USR_CD
			   , U.USR_NM
			   , A.USE_YN
			   , A.FILE_YN
		  FROM TB_SURVEY A
		  	  LEFT OUTER JOIN TB_COMM_ORG O ON A.ORG_CD = O.ORG_CD
		      LEFT OUTER JOIN TB_COMM_USR U ON A.USR_CD = U.USR_CD
	 	 WHERE 1=1
	 	<isNotEmpty property="searchWord">
	 		<isEqual property="searchWd" compareValue="1">
	 		AND ( A.SURVEY_NM LIKE '%' || #searchWord#  || '%' 
	 			 OR  A.SURVEY_NM LIKE '%' || UPPER(#searchWord#)  || '%'
	 			 OR  A.SURVEY_NM LIKE '%' || LOWER(#searchWord#)  || '%'
	 		 )
	 		</isEqual>
	 	</isNotEmpty>
	 	<isEqual property="useYn" compareValue="Y">
	 		AND A.USE_YN = 'Y'
	 	</isEqual>
	 	<isEqual property="useYn" compareValue="N">
	 		AND A.USE_YN = 'N'
	 	</isEqual>
	 	 ORDER BY USE_YN DESC, SURVEY_ID DESC, END_DTTM DESC
	</select>
	
	
	<select id="SurveyDao.getSurveyId" parameterClass="egovframework.admin.bbs.service.Survey" resultClass="java.lang.Integer">
	    SELECT NVL(MAX(SURVEY_ID)+1,10000)
	      FROM TB_SURVEY
	</select>
	
	
	<insert id="SurveyDao.insertSurvey" parameterClass="egovframework.admin.bbs.service.Survey" >
			
		
		INSERT INTO TB_SURVEY 
			(  SURVEY_ID
			 , LANG_TAG
			 , SURVEY_PPOSE
			 , SURVEY_NM
			 , SURVEY_EXP
			 , SURVEY_DESC
			 , START_DTTM
			 , END_DTTM
			 , ORG_CD
			 , USR_CD
			 , USE_YN
			 , AXIS_X
			 , AXIS_Y
			 <isNotNull property="ipDupYn">
					, IP_DUP_YN
			 </isNotNull>
			 <isNotNull property="user1Yn">
					, USER1_YN
			 </isNotNull>
			 <isNotNull property="loginYn">
					, LOGIN_YN
			 </isNotNull>
			 <isNotNull property="fileYn">
					, FILE_YN
			 </isNotNull>
			 <isNotNull property="fileExp">
					, FILE_EXP
			 </isNotNull>
			 <isNotNull property="userNameYn">
					, USER_NAME_YN
			 </isNotNull>
			 <isNotNull property="userTelYn">
					, USER_TEL_YN
			 </isNotNull>
			 <isNotNull property="userHpYn">
					, USER_HP_YN
			 </isNotNull>
			 <isNotNull property="userEmailYn">
					, USER_EMAIL_YN
			 </isNotNull>
			) 
		VALUES
			(
				  #surveyId#
				, #langTag#
				, #surveyPpose#
				, #surveyNm#
				, #surveyExp#
				, #surveyDesc:CLOB#
				, TO_DATE(#startDttm#,'YYYY-MM-DD HH24')
				, TO_DATE(#endDttm#|| ':59:59', 'YYYY-MM-DD HH24:mi:ss')
				, #orgCd#
				, #usrCd#
				, #useYn#
				, #axisX#
				, #axisY#
				<isNotNull property="ipDupYn">
					, #ipDupYn#
				</isNotNull>
				<isNotNull property="user1Yn">
					, #user1Yn#
				</isNotNull>
				<isNotNull property="loginYn">
					, #loginYn#
				</isNotNull>
				<isNotNull property="fileYn">
					, #fileYn#
				</isNotNull>
				<isNotNull property="fileExp">
					, #fileExp#
			 	</isNotNull>
			 	<isNotNull property="userNameYn">
			 		,#userNameYn#
				 </isNotNull>
				 <isNotNull property="userTelYn">
				 	,#userTelYn#
				 </isNotNull>
				 <isNotNull property="userHpYn">
				 	,#userHpYn#
				 </isNotNull>
				 <isNotNull property="userEmailYn">
				 	,#userEmailYn#
				 </isNotNull>
			)
	</insert>
	
	<update id="SurveyDao.updateSurvey" parameterClass="egovframework.admin.bbs.service.Survey">
		UPDATE TB_SURVEY
		   SET   LANG_TAG = #langTag#
		   	   , SURVEY_PPOSE = #surveyPpose#
		   	   , SURVEY_NM = #surveyNm#
		   	   , SURVEY_EXP = #surveyExp#
		   	   , SURVEY_DESC = #surveyDesc:CLOB#
		   	   , START_DTTM = TO_DATE(#startDttm#, 'YYYY-MM-DD HH24')
		   	   , END_DTTM = TO_DATE(#endDttm#|| ':59:59', 'YYYY-MM-DD HH24:mi:ss')
		   	   , ORG_CD = #orgCd#
		   	   , USR_CD = #usrCd#
		   	   , USE_YN = #useYn#
		   	   , UPD_DTTM = SYSDATE
		   	   <isNotEmpty property="axisX">
		   	   , AXIS_X = #axisX#
		   	   </isNotEmpty>
		   	   <isNotEmpty property="axisY">
		   	   , AXIS_Y = #axisY#
		   	   </isNotEmpty>
		   	   <isNotEmpty property="loginYn">
		   	   , LOGIN_YN = #loginYn#
		   	   </isNotEmpty>
		   	   <isEmpty property="loginYn">
		   	   , LOGIN_YN = 'N'
		   	   </isEmpty>
		   	   <isNotEmpty property="ipDupYn">
		   	   , IP_DUP_YN = #ipDupYn#
		   	   </isNotEmpty>
		   	   <isEmpty property="ipDupYn">
		   	   , IP_DUP_YN = 'N'
		   	   </isEmpty>
		   	   <isNotEmpty property="user1Yn">
		   	   , USER1_YN = #user1Yn#
		   	   </isNotEmpty>
		   	   <isEmpty property="user1Yn">
		   	   , USER1_YN = 'N'
		   	   </isEmpty>
		   	   
		   	     <isNotEmpty property="fileYn">
		   	   , FILE_YN = #fileYn#
		   	   </isNotEmpty>
		   	    <isEmpty property="fileYn">
		   	   , FILE_YN = 'N'
		   	   </isEmpty>
		   	   <isNotEmpty property="fileExp">
				, FILE_EXP = #fileExp#
			   </isNotEmpty>
			    <isEmpty property="fileExp">
		   	   , FILE_EXP = null
		   	   </isEmpty>
		   	   
		   	   <isNotEmpty property="userNameYn">
		   	   , USER_NAME_YN = #userNameYn#
		   	   </isNotEmpty>
		   	   <isEmpty property="userNameYn">
		   	   , USER_NAME_YN = 'N'
		   	   </isEmpty>
		   	   
		   	   <isNotEmpty property="userTelYn">
		   	   , USER_TEL_YN = #userTelYn#
		   	   </isNotEmpty>
		   	   <isEmpty property="userTelYn">
		   	   , USER_TEL_YN = 'N'
		   	   </isEmpty>
		   	   
		   	   <isNotEmpty property="userHpYn">
		   	   , USER_HP_YN = #userHpYn#
		   	   </isNotEmpty>
		   	   <isEmpty property="userHpYn">
		   	   , USER_HP_YN = 'N'
		   	   </isEmpty>
		   	   
		   	   <isNotEmpty property="userEmailYn">
		   	   , USER_EMAIL_YN = #userEmailYn#
		   	   </isNotEmpty>
		   	   <isEmpty property="userEmailYn">
		   	   , USER_EMAIL_YN = 'N'
		   	   </isEmpty>
		 WHERE SURVEY_ID = #surveyId#
	</update>
	
	<!-- 설문응답을 한명이라도 했다면 설문삭제를 못한다.  -->
	<delete id="SurveyDao.deleteSurvey" parameterClass="egovframework.admin.bbs.service.Survey">
		<![CDATA[
	
		 DELETE
		   FROM TB_SURVEY A
		  WHERE A.SURVEY_ID = #surveyId#
		    AND NOT EXISTS (
		  				 SELECT 1
		  				   FROM TB_SURVEY_ANS B
		  				  WHERE 1=1
		  				    AND A.SURVEY_ID = B.SURVEY_ID
		  				    AND B.SURVEY_ID = #surveyId#
		  				)
		]]>
	</delete>
	
	<delete id="SurveyDao.deleteSurveyQuest" parameterClass="egovframework.admin.bbs.service.Survey">
		DELETE FROM TB_SURVEY_QUEST
		WHERE SURVEY_ID = #surveyId#
	</delete>
	
	<delete id="SurveyDao.deleteSurveyExam" parameterClass="egovframework.admin.bbs.service.Survey">
		DELETE FROM TB_SURVEY_EXAM
		WHERE SURVEY_ID = #surveyId#
	</delete>
	
	<!-- 설문 단건조회  -->
	<select id="SurveyDao.surveyRetr" parameterClass="egovframework.admin.bbs.service.Survey" resultMap="SurveyRetr" >
		SELECT  A.SURVEY_ID
			  , A.SURVEY_NM
			  , A.SURVEY_PPOSE
			  , A.LANG_TAG
			  , A.IP_DUP_YN
			  , A.SURVEY_EXP
			  , TO_CHAR(A.START_DTTM,'YYYY-MM-DD HH24') AS START_DTTM
			  , TO_CHAR(A.END_DTTM,'YYYY-MM-DD HH24') AS END_DTTM
			  , A.USER1_YN
			  , A.ORG_CD
			  , A.USR_CD
			  , A.LOGIN_YN
			  , A.USE_YN
			  , C.ORG_NM
			  , D.USR_NM
			  , A.SURVEY_DESC
			  , A.AXIS_X
			  , A.AXIS_Y
			  , A.FILE_YN
			  , A.FILE_EXP
			  , A.USER_NAME_YN
			   , A.USER_TEL_YN
			   , A.USER_HP_YN
			   , A.USER_EMAIL_YN
		  FROM TB_SURVEY A
		 INNER JOIN TB_SURVEY B
		    ON A.SURVEY_ID = B.SURVEY_ID
		   AND B.SURVEY_ID = #surveyId#
		LEFT OUTER JOIN TB_COMM_ORG C
		    ON A.ORG_CD = C.ORG_CD
		  LEFT OUTER JOIN TB_COMM_USR D
		    ON A.USR_CD = D.USR_CD
		  WHERE 1=1
	</select>
	
	<select id="SurveyDao.selectSurveyPop" parameterClass="egovframework.admin.bbs.service.Survey" resultMap="SurveyPop">
		SELECT   A.SURVEY_ID
			   , A.SURVEY_NM
			   , A.LANG_TAG
			   , A.IP_DUP_YN
			   , TO_CHAR(A.START_DTTM,'YYYY-MM-DD') AS START_DTTM
			   , TO_CHAR(A.END_DTTM,'YYYY-MM-DD') AS END_DTTM
			   , A.ORG_CD
			   , A.USR_CD
			   , A.USE_YN
			   , A.SURVEY_EXP
			   , A.USER1_YN
			   , A.USE_YN
			   , A.LOGIN_YN
			   , A.SURVEY_PPOSE
			   , A.FILE_YN
			   , A.FILE_EXP
			   , A.USER_NAME_YN
			   , A.USER_TEL_YN
			   , A.USER_HP_YN
			   , A.USER_EMAIL_YN
		  FROM TB_SURVEY A
	 	 WHERE A.SURVEY_ID = #surveyId#
	</select>
	
	<select id="SurveyDao.selectSurveyQuestCnt" parameterClass="egovframework.admin.bbs.service.Survey" resultClass="java.lang.Integer">
		SELECT COUNT(*) FROM TB_SURVEY_QUEST
		WHERE SURVEY_ID = #surveyId#
	</select>
	
	<select id="SurveyDao.selectSurveyExamCnt" parameterClass="egovframework.admin.bbs.service.Survey" resultClass="java.lang.Integer">
		SELECT COUNT(*) FROM TB_SURVEY_EXAM
		WHERE SURVEY_ID = #surveyId#
	</select>
	
	<select id="SurveyDao.selectSurveyPopup" parameterClass="egovframework.admin.bbs.service.Survey" resultClass="java.util.LinkedHashMap">
		SELECT A.SURVEY_ID
		     , A.SURVEY_NM
		     , A.START_DTTM
		     , A.END_DTTM
		     , A.AXIS_X
		     , A.AXIS_Y
		     , A.FILE_YN
		  FROM TB_SURVEY A
		 WHERE A.USE_YN = 'Y'
		   AND SYSDATE
				   BETWEEN A.START_DTTM
				   AND A.END_DTTM
		   AND (SELECT COUNT(1) FROM TB_SURVEY_QUEST B WHERE A.SURVEY_ID = B.SURVEY_ID) > 0
	</select>
	
	<update id="SurveyDao.selectSurveyUseYnUpdate" parameterClass="egovframework.admin.bbs.service.Survey" >
		UPDATE TB_SURVEY
		SET USE_YN = #useYn#
		WHERE SURVEY_ID = #surveyId#
	</update>
</sqlMap>